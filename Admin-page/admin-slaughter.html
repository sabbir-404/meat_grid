<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Slaughterhouse Dashboard</title>

  <!-- unchanged external assets from your original file -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <!-- original styles preserved -->
  <style>
    body {
      background-color: #f4f6f9;
    }
    .wrapper {
      display: flex;
    }
    .sidebar {
      width: 250px;
      height: 100vh;
      background: #343a40;
      color: white;
      padding: 20px 0;
      position: fixed;
      display: flex;
      flex-direction: column;
    }
    .sidebar .text-center {
      margin-bottom: 15px;
    }
    .sidebar h5 {
      padding: 0 20px;
      margin-bottom: 20px;
    }
    .sidebar a {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      color: #ccc;
      text-decoration: none;
      border-left: 3px solid transparent;
    }
    .sidebar a:hover,
    .sidebar a.active {
      color: white;
      background-color: #495057;
      border-left: 3px solid #ffffff;
      font-weight: bold;
    }
    .dashboard-container {
      margin-left: 270px;
      padding: 30px;
      width: calc(100% - 270px);
    }
    .card {
      margin-bottom: 20px;
    }
    footer {
      margin-left: 270px;
    }
    .user-dropdown {
      z-index: 9999 !important;
      position: fixed;
      top: 20px;
      right: 30px;
    }
    .dropdown-menu {
      z-index: 9999 !important;
    }
    .table-actions {
      display: flex;
      gap: 8px;
    }
    td input, td select { min-width: 140px; }
    .small-note { font-size:0.85rem; color:#6c757d; }
    /* alert box */
    #alertBox { margin-bottom: 16px; display:none; }
  </style>
</head>
<body>

<!-- User Profile Dropdown (UNCHANGED) -->
<div class="user-dropdown">
  <div class="dropdown">
    <button class="btn btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="fas fa-user-circle"></i>
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li><a class="dropdown-item" href="../Login-signup-and-profile-page/profile.php">View Profile</a></li>
      <li><hr class="dropdown-divider" /></li>
      <li><a class="dropdown-item" href="../Login-signup-and-profile-page/logout.php">Logout</a></li>
    </ul>
  </div>
</div>

<!-- Sidebar (UNCHANGED from your original file) -->
<div class="sidebar">
  <div class="text-center">
    <img src="Logo/Logo white.png" alt="Meat Grid Logo" style="max-width: 100px; height: auto;">
  </div>
  <h5><i class="fas fa-tachometer-alt me-2"></i>Admin Panel</h5>
  <a href="admin-dashboard.html"><i class="fas fa-home me-2"></i>Dashboard</a>
  <a href="admin-farmer.html"><i class="fas fa-tractor me-2"></i>Livestock</a>
  <a href="admin-nonmeat.html"><i class="fas fa-leaf me-2"></i>Non-Meat Products</a>
  <a href="admin-retailers.html"><i class="fas fa-store me-2"></i>Retailer Sales</a>
  <a href="#" class="active"><i class="fas fa-industry me-2"></i>Slaughterhouse Info</a>
  <a href="admin-meat_products.html"><i class="fas fa-cubes me-2"></i>Processed Meat</a>
  <a href="admin-wholesalers.html"><i class="fas fa-boxes me-2"></i>Wholesale Data</a>
  <a href="admin-consumers.html"><i class="fas fa-users me-2"></i>Consumer Feedback</a>
  <a href="admin-nutrition.html"><i class="fas fa-apple-alt me-2"></i>Nutrition & Health</a>
</div>

<!-- Main Content (only capacity + summary now) -->
<div class="dashboard-container container-fluid">
  <h2 class="mb-4">Slaughterhouse Dashboard</h2>

  <!-- alert box for server / JSON errors -->
  <div id="alertBox" class="alert alert-danger" role="alert"></div>

  <!-- Slaughterhouse Capacity Overview -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title d-flex justify-content-between align-items-center">
        Slaughterhouse Capacity Overview
        <div>
          <button class="btn btn-sm btn-success" id="btnAddCapacity"><i class="fas fa-plus"></i> Add</button>
        </div>
      </h5>

      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="capacityTable">
          <thead class="table-dark">
            <tr>
              <th>Slaughterhouse Name</th>
              <th>Slaughter Rate (animals/day)</th>
              <th>Processing Capacity (kg/day)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="capacityBody">
            <!-- rows loaded from get_capacity.php -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Total Meat Production Summary (aggregated from processed meat saved in DB) -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Total Meat Production Summary</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="summaryTable">
          <thead class="table-dark">
            <tr>
              <th>Meat Type</th>
              <th>Breed</th>
              <th>Storing Temperature (Â°C)</th>
              <th>Yield Weight (kg)</th>
            </tr>
          </thead>
          <tbody id="summaryBody">
            <!-- aggregated rows here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Meat Quantity by Type</h5>
      <canvas id="meatBarChart" style="width: 100%; max-height: 300px;"></canvas>
    </div>
  </div>
</div>

<!-- unchanged external scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/*
  JS wiring:
  - get_capacity.php -> loads slaughterhouse list
  - add_capacity.php -> add / update (requires session user_id on server)
  - delete_capacity.php -> delete (requires session)
  - get_processed_meat.php -> returns processed meat rows; we aggregate on client

  Save / edit / delete always reload canonical data from server (so no client-only state is lost on reload).
*/

const API_BASE = './'; // Admin-page folder
const alertBox = document.getElementById('alertBox');

function showAlert(message) {
  alertBox.style.display = 'block';
  alertBox.textContent = message;
}
function hideAlert() {
  alertBox.style.display = 'none';
  alertBox.textContent = '';
}

async function fetchJSON(url, opts = {}) {
  // Robust JSON fetch with helpful debug output on invalid JSON
  const res = await fetch(url, opts);
  const text = await res.text();
  try {
    const json = text ? JSON.parse(text) : null;
    if (!res.ok) {
      const errMsg = json?.error || ('Server error ' + res.status);
      throw new Error(errMsg);
    }
    hideAlert();
    return json;
  } catch (err) {
    // show truncated raw response in console for debugging
    console.error('Invalid JSON from', url, 'raw response:', text);
    showAlert('Server returned invalid JSON for "' + url + '". Open DevTools console to see raw response (first 1000 chars).');
    // log truncated raw to console to make debugging easier
    console.log('--- RAW RESPONSE START ---');
    console.log(text.substring(0, 2000));
    console.log('--- RAW RESPONSE END ---');
    throw new Error('Invalid JSON from server: ' + err.message);
  }
}

/* ---------- Data stores ---------- */
let slaughterhouseList = [];
let processedData = [];

/* ---------- Chart ---------- */
const chart = new Chart(document.getElementById('meatBarChart'), {
  type: 'bar',
  data: { labels: [], datasets: [{ label: 'Quantity (kg)', data: [] }] },
  options: {
    responsive: true,
    plugins: { legend: { display: false }, title: { display: true, text: 'Total Quantity by Meat Type' } },
    scales: { y: { beginAtZero: true } }
  }
});

/* ---------- Loaders ---------- */
async function loadSlaughterhouses() {
  try {
    const data = await fetchJSON(API_BASE + 'get_capacity.php', { cache: 'no-store' });
    // get_capacity returns an array directly
    slaughterhouseList = Array.isArray(data) ? data : (data.data || []);
    renderCapacityTable();
  } catch (err) {
    console.error(err);
  }
}

async function loadProcessedMeatAndRenderSummary() {
  try {
    const data = await fetchJSON(API_BASE + 'get_processed_meat.php', { cache: 'no-store' });
    processedData = Array.isArray(data) ? data : (data.data || []);
    renderSummary();
    renderChart();
  } catch (err) {
    console.error(err);
  }
}

/* ---------- Rendering: capacity ---------- */
function renderCapacityTable() {
  const tbody = document.getElementById('capacityBody');
  tbody.innerHTML = '';
  (slaughterhouseList || []).forEach(s => {
    const tr = document.createElement('tr');
    tr.dataset.id = s.slaughterhouse_ID || '';
    tr.innerHTML = `
      <td>${escapeHtml(s.name || '')}</td>
      <td>${escapeHtml(s.slaughter_rate || '')}</td>
      <td>${escapeHtml(s.processing_capacity || '')}</td>
      <td class="table-actions">
        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCapacityRow(this)"><i class="fas fa-pen"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteCapacity('${encodeURIComponent(s.slaughterhouse_ID || '')}')"><i class="fas fa-trash"></i></button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* Add new client-only row for capacity */
document.getElementById('btnAddCapacity').addEventListener('click', addCapacityRow);

function addCapacityRow() {
  const tbody = document.getElementById('capacityBody');
  const tr = document.createElement('tr');
  tr.dataset.unsaved = 'true';
  tr.innerHTML = `
    <td><input class="form-control form-control-sm" placeholder="Name"></td>
    <td><input class="form-control form-control-sm" type="number" placeholder="animals/day"></td>
    <td><input class="form-control form-control-sm" type="number" placeholder="kg/day"></td>
    <td class="table-actions">
      <button class="btn btn-sm btn-success me-1" onclick="saveNewCapacity(this)"><i class="fas fa-save"></i> Save</button>
      <button class="btn btn-sm btn-secondary" onclick="cancelRow(this)"><i class="fas fa-times"></i></button>
    </td>`;
  tbody.prepend(tr);
  tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

async function saveNewCapacity(btn) {
  const row = btn.closest('tr');
  const inputs = row.querySelectorAll('input');
  const name = inputs[0].value.trim();
  const slaughter_rate = inputs[1].value;
  const processing_capacity = inputs[2].value;
  if (!name) { alert('Name is required'); return; }
  btn.disabled = true;
  try {
    const fd = new FormData();
    fd.append('name', name);
    if (slaughter_rate !== '') fd.append('slaughter_rate', slaughter_rate);
    if (processing_capacity !== '') fd.append('processing_capacity', processing_capacity);
    const res = await fetch(API_BASE + 'add_capacity.php', { method: 'POST', body: fd, cache: 'no-store' });
    const json = await res.text();
    // try parse safely to give better debug info if server sends non-JSON
    try {
      const parsed = json ? JSON.parse(json) : null;
      if (!res.ok) throw new Error(parsed?.error || ('Server error ' + res.status));
      if (parsed && parsed.success) {
        await loadSlaughterhouses();
        await loadProcessedMeatAndRenderSummary();
      } else {
        throw new Error(parsed?.error || 'Save failed');
      }
    } catch (parseErr) {
      console.error('Raw response from add_capacity.php:', json);
      showAlert('Server returned invalid JSON when saving capacity. Check PHP error logs or DevTools console.');
    }
  } catch (err) {
    console.error(err);
    showAlert('Failed to save capacity: ' + err.message);
    btn.disabled = false;
  }
}

function editCapacityRow(btn) {
  const row = btn.closest('tr');
  const cells = row.querySelectorAll('td');
  const vals = Array.from(cells).slice(0,3).map(td => td.textContent.trim());
  cells[0].innerHTML = `<input class="form-control form-control-sm" value="${escapeHtml(vals[0])}">`;
  cells[1].innerHTML = `<input class="form-control form-control-sm" type="number" value="${escapeHtml(vals[1])}">`;
  cells[2].innerHTML = `<input class="form-control form-control-sm" type="number" value="${escapeHtml(vals[2])}">`;
  cells[3].innerHTML = `<button class="btn btn-sm btn-success me-1" onclick="saveEditedCapacity(this)"><i class="fas fa-save"></i> Save</button> <button class="btn btn-sm btn-secondary" onclick="cancelRow(this)"><i class="fas fa-times"></i></button>`;
}

async function saveEditedCapacity(btn) {
  const row = btn.closest('tr');
  const id = row.dataset.id || '';
  const inputs = row.querySelectorAll('input');
  const name = inputs[0].value.trim();
  const slaughter_rate = inputs[1].value;
  const processing_capacity = inputs[2].value;
  if (!name) { alert('Name is required'); return; }
  btn.disabled = true;
  try {
    const fd = new FormData();
    if (id) fd.append('slaughterhouse_ID', id);
    fd.append('name', name);
    if (slaughter_rate !== '') fd.append('slaughter_rate', slaughter_rate);
    if (processing_capacity !== '') fd.append('processing_capacity', processing_capacity);
    const res = await fetch(API_BASE + 'add_capacity.php', { method: 'POST', body: fd, cache: 'no-store' });
    const text = await res.text();
    try {
      const parsed = text ? JSON.parse(text) : null;
      if (!res.ok) throw new Error(parsed?.error || ('Server error ' + res.status));
      if (parsed && parsed.success) {
        await loadSlaughterhouses();
        await loadProcessedMeatAndRenderSummary();
      } else throw new Error(parsed?.error || 'Save failed');
    } catch (parseErr) {
      console.error('Raw response from add_capacity.php:', text);
      showAlert('Server returned invalid JSON when saving edited capacity. Check PHP logs.');
    }
  } catch (err) {
    console.error(err);
    showAlert('Failed to save edited capacity: ' + err.message);
    btn.disabled = false;
  }
}

async function deleteCapacity(encodedId) {
  const id = decodeURIComponent(encodedId);
  if (!confirm('Delete this slaughterhouse?')) return;
  try {
    const res = await fetch(API_BASE + 'delete_capacity.php?slaughterhouse_ID=' + encodeURIComponent(id), { cache: 'no-store' });
    const text = await res.text();
    try {
      const parsed = text ? JSON.parse(text) : null;
      if (!res.ok) throw new Error(parsed?.error || ('Server error ' + res.status));
      if (parsed && parsed.success) {
        await loadSlaughterhouses();
        await loadProcessedMeatAndRenderSummary();
      } else throw new Error(parsed?.error || 'Delete failed');
    } catch (parseErr) {
      console.error('Raw response from delete_capacity.php:', text);
      showAlert('Server returned invalid JSON when deleting capacity. Check PHP logs.');
    }
  } catch (err) {
    console.error(err);
    showAlert('Failed to delete capacity: ' + err.message);
  }
}

/* ---------- Summary (aggregate processed data) ---------- */
function renderSummary() {
  const tbody = document.getElementById('summaryBody');
  tbody.innerHTML = '';
  const map = {}; // key => total weight
  processedData.forEach(r => {
    const meat = (r.meat_type || r.meatType || '').trim() || '(unknown)';
    const breed = (r.breed || '').trim() || '(unknown)';
    // weight may come from yield_weight or weight field; handle both
    let w = 0;
    if (r.weight !== undefined && r.weight !== null && r.weight !== '') w = parseFloat(r.weight) || 0;
    else if (r.yield_weight !== undefined && r.yield_weight !== null && r.yield_weight !== '') w = parseFloat(r.yield_weight) || 0;
    else if (r.yield !== undefined && r.yield !== null && r.yield !== '') w = parseFloat(r.yield) || 0;
    const key = meat + '||' + breed;
    map[key] = (map[key] || 0) + w;
  });

  Object.keys(map).sort().forEach(key => {
    const [meat, breed] = key.split('||');
    const total = map[key];
    const storingTemp = (meat.toLowerCase().includes('drumstick') || breed === 'Broiler') ? '2' : '4';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(meat)}</td><td>${escapeHtml(breed)}</td><td>${storingTemp}</td><td>${Number(total).toFixed(3)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderChart() {
  const map = {};
  processedData.forEach(r => {
    const meat = (r.meat_type || r.meatType || '').trim() || '(unknown)';
    let w = 0;
    if (r.weight !== undefined && r.weight !== null && r.weight !== '') w = parseFloat(r.weight) || 0;
    else if (r.yield_weight !== undefined && r.yield_weight !== null && r.yield_weight !== '') w = parseFloat(r.yield_weight) || 0;
    map[meat] = (map[meat] || 0) + w;
  });
  const labels = Object.keys(map);
  const data = labels.map(l => Number(map[l].toFixed(3)));
  chart.data.labels = labels;
  chart.data.datasets[0].data = data;
  chart.update();
}

/* ---------- Utilities ---------- */
function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
}

function cancelRow(btn) {
  const row = btn.closest('tr');
  if (row && row.dataset.unsaved === 'true') {
    row.remove();
    return;
  }
  // otherwise reload canonical server data
  loadSlaughterhouses();
}

/* ---------- Init ---------- */
window.addEventListener('load', () => {
  hideAlert();
  loadSlaughterhouses();
  loadProcessedMeatAndRenderSummary();
});
</script>
</body>
</html>




