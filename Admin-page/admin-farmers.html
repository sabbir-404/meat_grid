<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Farmer View - Meat Grid</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f4f6f9; overflow-x: hidden; }
    .sidebar { width: 250px; height: 100vh; background: #343a40; color: white; position: fixed; padding: 20px 0; display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; }
    .sidebar .logo { text-align: center; margin-bottom: 1rem; }
    .sidebar .logo img { max-width: 120px; }
    .sidebar a { padding: 12px 20px; color: #ccc; text-decoration: none; display: flex; align-items: center; border-left: 3px solid transparent; white-space: nowrap; }
    .sidebar a:hover, .sidebar a.active { color: white; background-color: #495057; font-weight: bold; border-left: 3px solid #fff; }
    .dashboard-container { margin-left: 250px; padding: 30px; width: calc(100% - 250px); }
    .user-dropdown { position: fixed; top: 20px; right: 30px; z-index: 9999; }
    .table-responsive { overflow-x: auto; }
    .btn-small { padding: .25rem .5rem; font-size: .85rem; }
  </style>
</head>
<body>

  <!-- User Dropdown -->
  <div class="user-dropdown">
    <div class="dropdown">
      <button class="btn btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown">
        <i class="fas fa-user-circle"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="../Login-signup-and-profile-page/profile.php">View Profile</a></li>
        <li><hr class="dropdown-divider"/></li>
        <li><a class="dropdown-item" href="../Login-signup-and-profile-page/logout.php">Logout</a></li>
      </ul>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <img src="../Logo/Logo white.png" alt="Meat Grid Logo">
    </div>
    <a href="admin-dashboard.html"><i class="fas fa-home me-2"></i>Dashboard</a>
    <a href="admin-farmers.html" class="active"><i class="fas fa-tractor me-2"></i>Farmer Data</a>
    <a href="admin-retailers.html"><i class="fas fa-store me-2"></i>Retailer Sales</a>
    <a href="admin-slaughter.html"><i class="fas fa-industry me-2"></i>Slaughterhouse Info</a>
    <a href="admin-meat_products.html"><i class="fas fa-cubes me-2"></i>Processed Meat</a>  
    <a href="admin-wholesalers.html"><i class="fas fa-boxes me-2"></i>Wholesale Data</a>
    <a href="admin-consumers.html"><i class="fas fa-users me-2"></i>Consumer Feedback</a>
    <a href="admin-nutrition.html"><i class="fas fa-apple-alt me-2"></i>Nutrition & Health</a>
  </div>

  <!-- Main Content -->
  <div class="dashboard-container container-fluid">
    <h2 class="mb-4">Farmer & Livestock Records</h2>

    <div class="d-flex justify-content-end mb-2">
      <button class="btn btn-success" id="btnAddRow">
        <i class="fas fa-plus"></i> Add
      </button>
    </div>

    <div class="mb-3 d-flex">
      <select id="columnSelect" class="form-select w-auto me-2">
        <option value="0">Farmer Name</option>
        <option value="1">Farmer ID</option>
        <option value="2">Date</option>
        <option value="3">Livestock ID</option>
        <option value="4">Breed</option>
        <option value="5">Type</option>
      </select>
      <input type="text" id="searchInput" class="form-control" placeholder="Search...">
    </div>

    <div class="table-responsive mb-4">
      <table class="table table-bordered table-striped" id="farmerTable">
        <thead class="table-dark">
          <tr>
            <th>Farmer Name</th>
            <th>Farmer ID</th>
            <th>Date</th>
            <th>Livestock ID</th>
            <th>Breed</th>
            <th>Type</th>
            <th>Count</th>
            <th>Avg Weight (kg)</th>
            <th>Slaughter Weight (kg)</th>
            <th>FCR</th>
            <th>Rearing Period (days)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="farmerTableBody"></tbody>
      </table>
    </div>

    <h4>Total Breed Count</h4>
    <div class="table-responsive mb-4">
      <table class="table table-bordered" id="summaryTable">
        <thead class="table-secondary"><tr><th>Breed</th><th>Total</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row">
      <div class="col-md-6 mb-4"><canvas id="breedChart"></canvas></div>
      <div class="col-md-6 mb-4"><canvas id="typeChart"></canvas></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let breedChart, typeChart;

    // Utilities
    function normalizeFarmerId(raw) {
      return (raw || '').toString().replace(/\D/g, '');
    }

    // Build an editable row element and return <tr>
    function buildRowElement(rowData = {}, editing = false) {
      const tr = document.createElement('tr');

      // Fields in order: username, user_id, entry_date, product_id, breed, animal_type, quantity, avg_weight, slaughter_weight, fcr, rearing_days
      const values = [
        rowData.username ?? '',
        (rowData.user_id !== undefined && rowData.user_id !== null) ? 'F' + rowData.user_id : '',
        rowData.entry_date ?? '',
        rowData.product_id ?? '',
        rowData.breed ?? '',
        rowData.animal_type ?? '',
        rowData.quantity ?? 0,
        rowData.avg_weight ?? 0,
        rowData.slaughter_weight ?? 0,
        rowData.fcr ?? 0,
        rowData.rearing_days ?? 0
      ];

      values.forEach((val, idx) => {
        const td = document.createElement('td');
        if (editing) {
          // Date input for date column (index 2)
          if (idx === 2) {
            td.innerHTML = <input type="date" class="form-control" value="${val ?? ''}">;
          } else {
            // For Farmer ID keep a visible input (allows typing F123 or 123)
            td.innerHTML = <input class="form-control" value="${val ?? ''}">;
          }
        } else {
          td.textContent = val ?? '';
        }
        tr.appendChild(td);
      });

      // Actions cell
      const actionTd = document.createElement('td');

      if (editing) {
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn btn-sm btn-success me-1 btn-small';
        saveBtn.innerHTML = '<i class="fas fa-save"></i>';
        saveBtn.addEventListener('click', () => saveEdit(saveBtn, rowData.product_id || ''));

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-sm btn-secondary btn-small';
        cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
        cancelBtn.addEventListener('click', () => loadData());

        actionTd.appendChild(saveBtn);
        actionTd.appendChild(cancelBtn);
      } else {
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-outline-primary me-1 btn-small';
        editBtn.innerHTML = '<i class="fas fa-pen"></i>';
        editBtn.addEventListener('click', () => editRow(rowData.product_id, editBtn));

        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-outline-danger btn-small';
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.addEventListener('click', () => deleteEntry(rowData.product_id));

        actionTd.appendChild(editBtn);
        actionTd.appendChild(delBtn);
      }

      tr.appendChild(actionTd);
      return tr;
    }

    // Render row; append to tbody
    function renderRow(data, editing = false) {
      const tbody = document.getElementById('farmerTableBody');
      const tr = buildRowElement(data, editing);
      tbody.appendChild(tr);
    }

    // Load all entries from server
    function loadData() {
      fetch('fetch_admin_livestock.php')
        .then(r => r.json())
        .then(rows => {
          const tbody = document.getElementById('farmerTableBody');
          tbody.innerHTML = '';
          rows.forEach(r => renderRow(r, false));
          updateSummaryAndCharts();
        })
        .catch(err => {
          console.error('Load error', err);
          alert('Failed to load data (check console).');
        });
    }

    // Add new editable row (blank)
    function addNewRow() {
      const today = new Date().toISOString().split('T')[0];
      const blank = {
        username: '',
        user_id: '',
        entry_date: today,
        product_id: '',
        breed: '',
        animal_type: '',
        quantity: 0,
        avg_weight: 0,
        slaughter_weight: 0,
        fcr: 0,
        rearing_days: 0
      };
      // Insert new editable row at top
      const tbody = document.getElementById('farmerTableBody');
      const tr = buildRowElement(blank, true);
      tbody.insertBefore(tr, tbody.firstChild);
    }

    // Edit existing: remove current row and insert editable one
    function editRow(pid, btn) {
      fetch(fetch_admin_livestock.php?product_id=${encodeURIComponent(pid)})
        .then(r => r.json())
        .then(arr => {
          if (!arr.length) return alert('Entry not found');
          // remove the existing display row (btn may be inside it)
          const existingRow = btn.closest('tr');
          existingRow.remove();
          // add editable row
          const tbl = document.getElementById('farmerTableBody');
          const tr = buildRowElement(arr[0], true);
          // insert at same position (prepend)
          tbl.insertBefore(tr, tbl.firstChild);
        })
        .catch(err => { console.error(err); alert('Fetch failed'); });
    }

    // Save or insert
    function saveEdit(btn, pid) {
      const tr = btn.closest('tr');
      const cells = tr.querySelectorAll('td');

      // cells mapping matches buildRowElement values:
      // 0 username, 1 user_id (with F prefix) , 2 entry_date (date input), 3 product_id, 4 breed, 5 animal_type, 6 quantity, 7 avg_weight, 8 slaughter_weight, 9 fcr, 10 rearing_days
      const username = cells[0].querySelector('input')?.value?.trim() ?? '';
      let userIdRaw = cells[1].querySelector('input')?.value ?? '';
      const entryDate = cells[2].querySelector('input')?.value ?? '';
      const productId = cells[3].querySelector('input')?.value?.trim() ?? '';
      const breed = cells[4].querySelector('input')?.value?.trim() ?? '';
      const animal_type = cells[5].querySelector('input')?.value?.trim() ?? '';
      const quantity = parseInt(cells[6].querySelector('input')?.value, 10) || 0;
      const avg_weight = parseFloat(cells[7].querySelector('input')?.value) || 0;
      const slaughter_weight = parseFloat(cells[8].querySelector('input')?.value) || 0;
      const fcr = parseFloat(cells[9].querySelector('input')?.value) || 0;
      const rearing_days = parseInt(cells[10].querySelector('input')?.value, 10) || 0;

      // normalize farmer id: remove non-digits
      userIdRaw = (userIdRaw || '').toString().replace(/\D/g, '');

      const payload = {
        product_id: productId,             // if empty = insert new
        username: username,
        user_id: userIdRaw,
        animal_type: animal_type,
        breed: breed,
        quantity: quantity,
        avg_weight: avg_weight,
        feed_type: '',         // you can add feed_type / health_status inputs if you want them visible
        health_status: '',
        entry_date: entryDate,
        slaughter_weight: slaughter_weight,
        fcr: fcr,
        rearing_days: rearing_days
      };

      console.log('Saving payload:', payload);

      fetch('admin_update_livestock.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(res => {
        if (res.success || res.status === 'success') {
          // success -> reload
          loadData();
        } else {
          console.error('Save error response', res);
          alert('Save failed: ' + (res.error || res.message || JSON.stringify(res)));
        }
      })
      .catch(err => {
        console.error('Request error', err);
        alert('Request error (check console).');
      });
    }

    // Delete
    function deleteEntry(pid) {
      if (!confirm('Are you sure you want to delete this entry?')) return;
      fetch('admin_delete_livestock.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: pid })
      })
      .then(r => r.json())
      .then(res => {
        if (res.success || res.status === 'success') loadData();
        else alert('Delete failed: ' + (res.error || res.message || JSON.stringify(res)));
      })
      .catch(err => { console.error(err); alert('Delete request failed'); });
    }

    // Search/filter
    document.getElementById('searchInput').addEventListener('input', () => {
      const col = parseInt(document.getElementById('columnSelect').value);
      const val = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('#farmerTableBody tr').forEach(tr => {
        const td = tr.cells[col];
        tr.style.display = td && td.textContent.toLowerCase().includes(val) ? '' : 'none';
      });
      updateSummaryAndCharts();
    });

    // Summary and charts
    function updateSummaryAndCharts() {
      const breedCount = {};
      const typeCount = {};
      document.querySelectorAll('#farmerTableBody tr').forEach(tr => {
        if (tr.style.display === 'none') return;
        const breed = tr.cells[4].textContent || '';
        const type = tr.cells[5].textContent || '';
        if (breed) breedCount[breed] = (breedCount[breed] || 0) + 1;
        if (type) typeCount[type] = (typeCount[type] || 0) + 1;
      });

      // Summary table
      const tbody = document.querySelector('#summaryTable tbody');
      tbody.innerHTML = '';
      Object.entries(breedCount).forEach(([k, v]) => {
        const row = tbody.insertRow();
        row.insertCell().textContent = k;
        row.insertCell().textContent = v;
      });

      // Breed chart (pie)
      const breedCtx = document.getElementById('breedChart').getContext('2d');
      if (breedChart) breedChart.destroy();
      breedChart = new Chart(breedCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(breedCount),
          datasets: [{ label: 'Breed Count', data: Object.values(breedCount), backgroundColor: Object.keys(breedCount).map(()=>hsl(${Math.random()*360},70%,50%)) }]
        }
      });

      // Type chart (bar)
      const typeCtx = document.getElementById('typeChart').getContext('2d');
      if (typeChart) typeChart.destroy();
      typeChart = new Chart(typeCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(typeCount),
          datasets: [{ label: 'Type Count', data: Object.values(typeCount) }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    // Attach add button
    document.getElementById('btnAddRow').addEventListener('click', addNewRow);

    // Initial load
    loadData();
  </script>
</body>
</html>